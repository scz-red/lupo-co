document.addEventListener('DOMContentLoaded', () => {
  // ====== CONFIG editable (solo cambias aquÃ­) ======
  const CONFIG = {
    EXCHANGE_RATE: 384,          // 1 BOB = 384 COP
    DISCOUNT: 0.10,              // âœ… 10% descuento
    MIN_AMOUNT: 10,              // mÃ­nimo BOB
    MAX_AMOUNT: 50000,           // mÃ¡ximo BOB
    WHATSAPP_NUMBER: '591775333489'
  };

  // ====== Elements ======
  const amountInput = document.getElementById('amount');
  const receivedInput = document.getElementById('received-amount');
  const resultCard = document.getElementById('result-card');
  const calculateBtn = document.getElementById('calculate-btn');
  const cotizDatetime = document.getElementById('cotiz-datetime');

  // Date/time
  const now = new Date();
  cotizDatetime.textContent = now.toLocaleString('es-BO', {
    day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'
  });

  // Reveal animation
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) entry.target.classList.add('visible');
    });
  }, { threshold: 0.12 });

  const observeIds = [
    'calculator-card','feature1','feature2','feature3','feature4',
    'testimonial1','testimonial2','testimonial3'
  ];
  observeIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) observer.observe(el);
  });

  // Helpers
  const formatCOP = (n) => Number(n).toLocaleString('es-CO');
  const clamp = (n, min, max) => Math.min(Math.max(n, min), max);

  // âœ… CÃ¡lculo Ãºnico con descuento (para UI y WhatsApp)
  const computeCOP = (bob) =>
    Math.round(bob * CONFIG.EXCHANGE_RATE * (1 - (Number(CONFIG.DISCOUNT) || 0)));

  function calculateTransfer() {
    const amount = parseFloat(amountInput.value);

    if (!Number.isFinite(amount) || amount <= 0) {
      receivedInput.value = '';
      resultCard.classList.remove('show');
      document.getElementById('result-amount').textContent = '0';
      return;
    }

    const safeAmount = clamp(amount, 0, CONFIG.MAX_AMOUNT);
    const receivedAmount = computeCOP(safeAmount);

    receivedInput.value = formatCOP(receivedAmount);
    document.getElementById('result-amount').textContent = formatCOP(receivedAmount);
    resultCard.classList.add('show');
  }

  // Auto calculate
  amountInput.addEventListener('input', calculateTransfer);

  // WhatsApp
  calculateBtn.addEventListener('click', () => {
    const amount = parseFloat(amountInput.value);

    if (!Number.isFinite(amount) || amount <= 0) {
      calculateBtn.classList.add('error');
      calculateBtn.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Monto invÃ¡lido';
      setTimeout(() => {
        calculateBtn.classList.remove('error');
        calculateBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Enviar dinero por WhatsApp';
      }, 1400);
      return;
    }

    if (amount < CONFIG.MIN_AMOUNT || amount > CONFIG.MAX_AMOUNT) {
      calculateBtn.classList.add('error');
      calculateBtn.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Rango: ${CONFIG.MIN_AMOUNT}â€“${CONFIG.MAX_AMOUNT} BOB`;
      setTimeout(() => {
        calculateBtn.classList.remove('error');
        calculateBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Enviar dinero por WhatsApp';
      }, 1600);
      return;
    }

    calculateBtn.classList.add('calculating');
    calculateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Preparando...';

    setTimeout(() => {
      const receivedAmount = computeCOP(amount);
      const message =
        `Hola LUPO ðŸ‘‹\n` +
        `Quiero enviar *${amount} BOB* a Colombia.\n` +
        `Recibe aprox: *${formatCOP(receivedAmount)} COP*.\n` +
        `Â¿Me ayudan con el envÃ­o?`;

      const url = `https://wa.me/${CONFIG.WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;

      calculateBtn.classList.remove('calculating');
      calculateBtn.classList.add('success');
      calculateBtn.innerHTML = '<i class="fa-solid fa-check"></i> Â¡Listo!';

      setTimeout(() => {
        window.open(url, '_blank', 'noopener');
        setTimeout(() => {
          calculateBtn.classList.remove('success');
          calculateBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Enviar dinero por WhatsApp';
        }, 1200);
      }, 450);
    }, 650);
  });

  // Calculate on load if prefilled
  if (amountInput.value) calculateTransfer();

  // ====== PWA installation ======
  let deferredPrompt;
  const installBtn = document.getElementById('install-btn');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'block';
  });

  installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    installBtn.style.display = 'none';
  });

  window.addEventListener('appinstalled', () => {
    installBtn.style.display = 'none';
  });

  // ====== iOS installation ======
  const iosModal = document.getElementById('ios-modal');
  const iosClose = document.getElementById('ios-close');

  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  const isInStandaloneMode = ('standalone' in window.navigator) && window.navigator.standalone;

  if (isIOS && isSafari && !isInStandaloneMode) {
    iosModal.style.display = 'block';
  }

  iosClose.addEventListener('click', () => {
    iosModal.style.display = 'none';
  });
});
